name: Contributor Credits

on:
  issues:
    types: [labeled]

jobs:
  update-credits:
    if: github.event.label.name == 'helpful contribution'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    concurrency:
      group: credits-update
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Post thank-you comment
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.issue.user.login;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `Thanks for the helpful contribution, @${author}! Your issue has been credited in our [contributors page](https://agent-of-empires.github.io/credits.html). ðŸŽ‰`
            });

      - name: Update credits data and markdown
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const username = issue.user.login;
            const issueNumber = issue.number;
            const issueTitle = issue.title;
            const labeledAt = new Date().toISOString();

            // Read or initialize credits.json
            const creditsPath = 'credits.json';
            let data;
            try {
              data = JSON.parse(fs.readFileSync(creditsPath, 'utf8'));
            } catch {
              data = { contributors: [] };
            }

            // Find or create contributor entry
            let contributor = data.contributors.find(c => c.username === username);
            if (!contributor) {
              contributor = { username, issues: [] };
              data.contributors.push(contributor);
            }

            // Idempotency: skip if issue already credited
            if (contributor.issues.some(i => i.number === issueNumber)) {
              console.log(`Issue #${issueNumber} already credited for @${username}, skipping.`);
              return;
            }

            contributor.issues.push({
              number: issueNumber,
              title: issueTitle,
              labeled_at: labeledAt
            });

            // Sort contributors by issue count descending
            data.contributors.sort((a, b) => b.issues.length - a.issues.length);

            fs.writeFileSync(creditsPath, JSON.stringify(data, null, 2) + '\n');

            // Generate markdown
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            let md = '# Contributors\n\n';
            md += 'Thank you to everyone who has helped improve Agent of Empires!\n\n';
            md += '| Rank | Contributor | Contributions | Issues |\n';
            md += '|------|-------------|:-------------:|--------|\n';

            data.contributors.forEach((c, i) => {
              const issueLinks = c.issues
                .map(issue => `[#${issue.number}](${repoUrl}/issues/${issue.number})`)
                .join(', ');
              md += `| ${i + 1} | [@${c.username}](https://github.com/${c.username}) | ${c.issues.length} | ${issueLinks} |\n`;
            });

            md += '\n*Auto-generated. Earn a spot by opening an issue that receives the "helpful contribution" label.*\n';

            fs.writeFileSync('CREDITS.md', md);
            fs.mkdirSync('docs', { recursive: true });
            fs.writeFileSync('docs/credits.md', md);

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add credits.json CREDITS.md docs/credits.md
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "docs: update contributor credits"
          git push
